# MP3ファイル名生成機能 基本設計書

## 1. 機能概要
スクリプトの内容を要約してMP3ファイルに意味のあるタイトルを付ける機能

### 変更前
- ファイル名: `output_1.mp3`, `output_2.mp3`

### 変更後  
- ファイル名: `1_{タイトル}.mp3`, `2_{タイトル}.mp3`
- タイトルはスクリプト内容から自動生成

## 2. 実装方式

### 2.1 タイトル生成
- Gemini APIを使用してスクリプトの最初の500文字から要約タイトルを生成
- 要件:
  - 最大20文字以内
  - 主要なトピックを反映
  - ファイル名として使用可能（特殊文字を除外）

### 2.2 ファイル名のサニタイズ
- 問題のある文字を置換: `<>:"/\|?*` → `_`
- スペースをアンダースコアに置換
- 制御文字を除去
- 最大50文字に制限

## 3. 実装詳細

### 3.1 追加メソッド

#### `_generate_title(text: str) -> str`
- スクリプトからタイトルを生成
- エラー時は "untitled" を返却

#### `_sanitize_filename(filename: str) -> str`
- ファイル名を安全な形式に変換
- 空の場合は "untitled" を返却

### 3.2 変更箇所
- `SynthesizePhase.__init__`: テキスト生成モデルの初期化を追加
- `_synthesize_audio`: タイトル生成とファイル名変更
- `_convert_to_mp3`: タイトルパラメータを追加

## 4. レビュー結果と今後の改善点

### 4.1 パフォーマンス
- 追加のAPI呼び出しによる処理時間増加（約15秒/タイトル）
- 改善案: タイトル生成のオプション化

### 4.2 エラーハンドリング
- 現状: タイトル生成失敗時は "untitled" 
- 改善案: リトライ機構の実装

### 4.3 ファイル名の堅牢性
- 改善案:
  - Unicode正規化
  - より厳密な長さ制限
  - 重複ファイル名の回避

## 5. テスト結果
- 正常動作確認済み
- 生成例:
  - `1_音声合成テスト.mp3`
  - `2_複数スクリプト処理テスト.mp3`