# Chunk分割機能改善 基本設計書

## 概要

PDF to Podcast Audio Generatorにおけるテキスト分割機能の精度向上を実現した。従来の機械的な分割から、意味のある単位での分割へと改善し、生成される音声の品質向上に貢献した。

## 課題

### 従来の問題点
1. **文の途中での分割**: marker_textの終了位置で機械的に分割していたため、文章が不自然に切れていた
2. **不均等な分割**: 31個のchunkが生成され、サイズが625文字〜32,303文字と大きくばらついていた
3. **意味の区切りを無視**: 章や節の構造を考慮せず、機械的に分割していた

### 根本原因
- Gemini APIへのプロンプトが「すべての自然な区切り」を要求していたため、過剰に分割点が生成される
- `_apply_splits`メソッドが文の途中（marker_textの直後）で分割している
- 目標chunk数の計算がなく、分割後のマージ処理に依存している

## 設計方針

### 1. Gemini APIによる直接分割
従来の「分割点を特定→適用」という2段階処理から、Gemini APIに直接chunk分割を依頼する方式へ変更。

### 2. 文字数制約の明確化
各chunkを600-1200文字に制限し、音声化時に約3-5分となるよう設計。

### 3. 意味的な一貫性の確保
- 章・節の区切りを優先的に利用
- 段落・文の途中では絶対に分割しない
- 各chunkが独立して理解できるよう配慮

## 実装詳細

### 1. 新メソッド: `_split_content_v2`

```python
def _split_content_v2(self, text: str, target_minutes: int = 5) -> List[Dict]:
    """新しい分割メソッド：Geminiに直接chunk分割を依頼"""
    # 日本語の読み上げ速度を基準に文字数を計算（約300文字/分）
    chars_per_minute = 300
    target_chars = target_minutes * chars_per_minute
    
    # 全体の文字数から適切なchunk数を計算
    text_length = len(text)
    estimated_chunks = max(1, int(text_length / target_chars))
```

### 2. 改善されたプロンプト

```
あなたは編集者兼ポッドキャスト脚本家です。
以下の全文テキストを、論理的にまとまりのある「節」単位で切り分けてください。

### 必須ルール
1. 各チャンクは **600〜1200字** に収めること。
2. 出力は **JSON配列**。各要素は下記キーを持つこと。  
   - "id": 連番（1,2,3…）  
   - "title": チャンク小見出し（15字以内）  
   - "text": チャンク本文（規定文字数内）  
3. 最後に `summary_quality` キーで "OK" もしくは "NEEDS REVIEW" を返すこと。
```

### 3. メタデータの保存

各chunkに対して以下のメタデータをJSON形式で保存：
- `id`: チャンク番号
- `title`: Geminiが生成したタイトル
- `char_count`: 文字数
- `estimated_minutes`: 推定読み上げ時間

### 4. CLIインターフェース改修

- `--chunk-size` パラメータを削除
- `--target-minutes` パラメータを追加（デフォルト5分）
- 後方互換性は意図的に排除（シンプルさを優先）

## 効果

### 定量的効果
- **分割数の適正化**: 31個→9個に削減（テストケースにて）
- **文字数の均等化**: 各chunkが600-1200文字の範囲に収束
- **読み上げ時間の予測可能性**: 各chunk約2.4-4.6分に標準化

### 定性的効果
- 文章の自然な区切りでの分割により、聴取体験が向上
- 各chunkに意味のあるタイトルが付与され、内容の把握が容易に
- 段落や文の途中での分割がなくなり、理解しやすい音声コンテンツに

## 今後の拡張可能性

1. **言語別の読み上げ速度対応**: 現在は日本語の300文字/分で固定だが、言語パラメータによる調整が可能
2. **ユーザー定義の分割ルール**: 特定のキーワードや記号での分割指定
3. **chunk間の関連性分析**: 前後のchunkとの関連性をメタデータに追加
4. **動的な文字数調整**: コンテンツの密度に応じた文字数の自動調整

## 実装日
2025年6月25日